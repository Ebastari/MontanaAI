<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Montana Chat AI </title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0b141a; --header:#202c33; --accent:#00a884;
  --user:#dcf8c6; --bot:#2a3942; --muted:#aebac1;
}
*{box-sizing:border-box;transition:all 0.2s ease;}
html,body{height:100%;margin:0;font-family:'Inter',system-ui;background:var(--bg);color:#e9edef;}
.frame{height:100vh;display:flex;align-items:center;justify-content:center;padding:12px;}
.phone{width:100%;max-width:420px;height:92vh;background:#10191f;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.6);overflow:hidden;display:flex;flex-direction:column;}
.header{height:62px;background:var(--header);display:flex;align-items:center;padding:10px 14px;gap:12px;}
.avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;}
.meta .name{font-weight:600;font-size:16px;}
.meta .sub{font-size:12px;color:var(--muted);}
.banner{padding:8px 14px;text-align:center;color:var(--muted);font-size:13px;border-bottom:1px solid rgba(255,255,255,0.05);}
.chat{flex:1;padding:14px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;background:#121c21;}
.msg-row{display:flex;flex-direction:column;max-width:80%;animation:fadeIn 0.25s ease forwards;opacity:0;transform:translateY(6px);}
.msg-row.user{align-self:flex-end;align-items:flex-end;}
.msg-row.bot{align-self:flex-start;align-items:flex-start;}
@keyframes fadeIn{to{opacity:1;transform:translateY(0);}}
.bubble{padding:10px 14px;border-radius:14px;line-height:1.4;font-size:14px;max-width:100%;white-space:pre-wrap;}
.bubble.user{background:var(--user);color:#000;border-bottom-right-radius:4px;}
.bubble.bot{background:var(--bot);border-bottom-left-radius:4px;}
.ts{font-size:11px;color:var(--muted);margin-top:4px;}
.composer{display:flex;gap:8px;align-items:center;padding:10px;background:#162126;border-top:1px solid rgba(255,255,255,0.05);}
textarea{flex:1;min-height:40px;padding:10px;border-radius:22px;border:none;background:#1a2a30;color:#fff;font-size:15px;outline:none;resize:none;max-height:100px;}
textarea:focus{background:#20363d;}
.send{width:46px;height:46px;border-radius:50%;background:var(--accent);border:none;color:#fff;font-weight:700;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.quick-btns{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;margin-left:auto;margin-right:auto;max-width:80%;align-self:flex-start;}
.quick-btn{background:#223b42;color:#fff;padding:6px 10px;border:none;border-radius:16px;cursor:pointer;font-size:13px;}
.quick-btn:hover{background:#2b4f56;}
.chat>select,.chat>input[type="date"]{display:block;margin:8px 0;max-width:80%;padding:8px;border-radius:8px;border:none;background:#1a2a30;color:#fff;font-size:14px;outline:none;align-self:flex-start;}
.chat>select:focus,.chat>input[type="date"]:focus{outline:2px solid var(--accent);}
</style>
</head>

<body>
<div class="frame">
  <div class="phone">
    <div class="header">
      <img class="avatar" src="https://i.pravatar.cc/150?img=5" alt="Montana">
      <div class="meta">
        <div class="name">Montana AI</div>
        <div class="sub">Asisten Monitoring Tanaman AI</div>
      </div>
    </div>
    <div class="banner">ğŸ”’ Data Bersifat Rahasia</div>
    <div id="chat" class="chat" aria-live="polite"></div>
    <div class="composer">
      <textarea id="input" placeholder="Ketik pesan Anda..." disabled></textarea>
      <button class="send" id="sendBtn" disabled>â¤</button>
    </div>
  </div>
</div>

<script>
const chat=document.getElementById('chat');
const input=document.getElementById('input');
const sendBtn=document.getElementById('sendBtn');
let DATA=[],RAW=[];
const sheetyUrl='https://api.sheety.co/ecf70bd684db7a654a0aa41957dff1a8/nursery/bibit';

const scrollBottom=()=>chat.scrollTop=chat.scrollHeight;
const timeNow=()=>new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

function bubble(txt,who='bot'){
  const row=document.createElement('div');
  row.className=`msg-row ${who}`;
  row.innerHTML=`<div class="bubble ${who}">${txt}</div><div class="ts">${timeNow()}</div>`;
  chat.appendChild(row); scrollBottom();
}

function quickReplies(options){
  const div=document.createElement('div');
  div.className='quick-btns';
  options.forEach(opt=>{
    const b=document.createElement('button');
    b.className='quick-btn'; b.textContent=opt.label;
    b.onclick=()=>{bubble(opt.label,'user');opt.action();div.remove();};
    div.appendChild(b);
  });
  chat.appendChild(div); scrollBottom();
}

function parseFlexibleDate(tgl){
  if(!tgl) return null;
  let d=null;
  if(/\d{4}-\d{2}-\d{2}/.test(tgl)) d=new Date(tgl);
  else if(/\d{2}\/\d{2}\/\d{4}/.test(tgl)){
    const [dd,mm,yy]=tgl.split('/').map(Number);
    d=new Date(yy,mm-1,dd);
  } else {
    const tryD=new Date(tgl);
    if(!isNaN(tryD)) d=tryD;
  }
  return d && !isNaN(d)?d:null;
}

function toNum(v){
  if(typeof v==="number") return v;
  if(!v) return 0;
  const s=String(v).replace(/[^\d\-.,]/g,'').replace(',','.');
  const n=parseFloat(s);
  return isNaN(n)?0:n;
}

function normalize(raw){
  return raw.map(r=>{
    const tgl=r.Tanggal||r.tanggal||r.date||'';
    const bibit=r.Bibit||r.bibit||r.jenis||'Tidak Diketahui';
    const masuk=toNum(r.Masuk||r.masuk);
    const keluar=toNum(r.Keluar||r.keluar);
    const mati=toNum(r.Mati||r.mati);
    const totalFromSheet=toNum(r.Total||r.total);
    const d=parseFlexibleDate(tgl);
    return {bibit,masuk,keluar,mati,totalFromSheet,tanggal:tgl,__date:d};
  }).filter(r=>r.__date);
}

const greetings = [
  "Halo, selamat datang di Montana AI, Aplikasi Artificial Intelligence. Senang dapat membantu Anda hari ini.",
  "Hai, terima kasih telah menggunakan layanan Montana AI. Apa yang ingin Anda cek hari ini?",
  "Halo, Montana AI siap membantu Anda memantau dan menganalisis data bibit.",
  "Assalamualaikum ğŸŒ¿, Montana AI siap membantu Anda dengan data terbaru.",
  "Halo, Montana AI hadir untuk mempermudah Anda dalam memantau stok bibit.",
  "Hai, sistem Montana AI siap digunakan. Silakan pilih menu yang Anda perlukan.",
  "Selamat datang kembali di Montana AI ğŸ‘‹. Mari kita lihat perkembangan data terkini.",
  "Halo, Montana AI siap memberikan laporan dan rekap data bibit sesuai kebutuhan Anda.",
  "Hai, Montana AI siap melayani Anda dengan data bibit yang akurat dan terbarui.",
  "Halo, senang bertemu kembali. Montana AI siap membantu Anda mengelola data hari ini."
];

const botSay=async(t)=>{await new Promise(r=>setTimeout(r,400));bubble(t,'bot');};

async function loadData(){
  await botSay("ğŸ”„ Sedang memuat data dari Nursery...");
  try{
    const r=await fetch(sheetyUrl);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j=await r.json();
    const key=Object.keys(j).find(k=>Array.isArray(j[k]));
    RAW=j[key]||[];
    DATA=normalize(RAW);
    if(!DATA.length) throw new Error("Tidak ada data valid dari Sheety.");
    input.disabled=false;sendBtn.disabled=false;
    await botSay(`âœ… Data berhasil dimuat (${DATA.length} baris data).`);
    const greet=greetings[Math.floor(Math.random()*greetings.length)];
    await botSay(greet+"<br><br>Silakan pilih menu di bawah:");
    showMainMenu();
  }catch(e){
    console.error(e);
    botSay(`âš ï¸ Gagal memuat data. Pastikan URL Sheety dan sheet Anda publik. (${e.message})`);
  }
}

function showMainMenu(){
  quickReplies([
    {label:'Realisasi Harian',action:()=>showRealisasi('harian')},
    {label:'Realisasi Mingguan',action:()=>showRealisasi('mingguan')},
    {label:'Realisasi Tahunan',action:()=>showRealisasi('tahunan')},
    {label:'Realisasi Masuk',action:showMasuk},
    {label:'Realisasi Keluar',action:showKeluar},
    {label:'Stok Global',action:showStok},
    {label:'Jenis Bibit',action:showJenis},
    {label:'Tanggal',action:showTanggal}
  ]);
}

async function showRealisasi(mode){
  await botSay(`ğŸ“Š Menampilkan realisasi ${mode}...`);
  if(DATA.length===0)return botSay("Tidak ada data.");
  const today=new Date();today.setHours(0,0,0,0);
  let filtered=[];
  if(mode==='harian')filtered=DATA.filter(d=>d.__date.toDateString()===today.toDateString());
  if(mode==='mingguan'){const start=new Date(today);start.setDate(today.getDate()-today.getDay());filtered=DATA.filter(d=>d.__date>=start);}
  if(mode==='tahunan'){const start=new Date(today.getFullYear(),0,1);filtered=DATA.filter(d=>d.__date>=start);}
  const masuk=filtered.reduce((a,b)=>a+b.masuk,0);
  const keluar=filtered.reduce((a,b)=>a+b.keluar,0);
  const mati=filtered.reduce((a,b)=>a+b.mati,0);
  await botSay(`<b>Realisasi ${mode}:</b><br>ğŸ“¥ Masuk: ${masuk}<br>ğŸ“¤ Keluar: ${keluar}<br>âš°ï¸ Mati: ${mati}`);
  showMainMenu();
}

async function showMasuk(){
  const total=DATA.reduce((a,b)=>a+b.masuk,0);
  await botSay(`ğŸ“¥ Total realisasi masuk: <b>${total}</b> bibit.`);
  showMainMenu();
}

async function showKeluar(){
  const total=DATA.reduce((a,b)=>a+b.keluar,0);
  await botSay(`ğŸ“¤ Total realisasi keluar: <b>${total}</b> bibit.`);
  showMainMenu();
}

async function showStok(){
  let totalSheet = 0;
  let totalManual = 0;
  DATA.forEach(r => {
    if (r.totalFromSheet && r.totalFromSheet !== 0) totalSheet += r.totalFromSheet;
    else totalManual += (r.masuk - r.keluar - r.mati);
  });
  const finalTotal = totalSheet > 0 ? totalSheet : totalManual;
  await botSay(`ğŸ“¦ Stok global saat ini: <b>${finalTotal}</b> bibit.<br><small>${totalSheet>0?"(berdasarkan kolom Total di Sheet)":"(dihitung manual dari Masuk-Keluar-Mati)"}</small>`);
  showMainMenu();
}

async function showJenis(){
  const jenis=[...new Set(DATA.map(d=>d.bibit))].filter(Boolean);
  await botSay("ğŸŒ± Pilih jenis bibit:");
  const select=document.createElement('select');
  select.innerHTML='<option value="">-- Pilih Jenis Bibit --</option>'+jenis.map(j=>`<option value="${j}">${j}</option>`).join('');
  select.onchange=()=>{const v=select.value;if(v){bubble(v,'user');showDataByJenis(v);select.remove();}};
  chat.appendChild(select);scrollBottom();
}

async function showDataByJenis(j){
  const f=DATA.filter(x=>x.bibit===j);
  if(!f.length)return botSay(`âŒ Tidak ada data untuk ${j}`);
  await botSay(`ğŸ“‹ Data untuk <b>${j}</b>:`);f.slice(0,5).forEach(r=>bubble(`ğŸ“… ${r.tanggal}<br>ğŸ“¥ ${r.masuk} | ğŸ“¤ ${r.keluar} | âš°ï¸ ${r.mati}`,'bot'));
  showMainMenu();
}

async function showTanggal(){
  await botSay("ğŸ“… Pilih tanggal untuk melihat data:");
  const inputDate=document.createElement('input');
  inputDate.type='date';
  inputDate.onchange=()=>{const v=inputDate.value;if(v){bubble(v,'user');showDataByDate(v);inputDate.remove();}};
  chat.appendChild(inputDate);scrollBottom();
}

async function showDataByDate(v){
  const d=new Date(v);d.setHours(0,0,0,0);
  const f=DATA.filter(x=>x.__date.toDateString()===d.toDateString());
  if(!f.length)return botSay(`âŒ Tidak ada data pada <b>${v}</b>.`);
  await botSay(`ğŸ“‹ Data tanggal <b>${v}</b>:`);f.forEach(r=>bubble(`ğŸŒ± ${r.bibit}<br>ğŸ“¥ ${r.masuk} | ğŸ“¤ ${r.keluar} | âš°ï¸ ${r.mati}`,'bot'));
  showMainMenu();
}

sendBtn.onclick=()=>{const v=input.value.trim();if(!v)return;bubble(v,'user');input.value='';botSay("Mohon gunakan tombol menu di bawah untuk interaksi. ğŸŒ¿");showMainMenu();};
input.addEventListener('keypress',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}});
loadData();
</script>
</body>
</html>
